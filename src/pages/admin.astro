---
import "@/styles/global.css";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <Fragment slot="head"><title>Admin — MI Wallpapers</title></Fragment>

  <div id="app" class="min-h-screen flex flex-col items-center justify-center px-4 py-12">

    {/* ── LOGIN ──────────────────────────── */}
    <div id="login" class="w-full max-w-xs flex flex-col gap-4">
      <h1 class="text-xl font-semibold tracking-tight text-center">Admin</h1>
      <input
        id="pw"
        type="password"
        placeholder="Password"
        autocomplete="current-password"
        class="w-full rounded-lg border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-950 px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-black dark:focus:ring-white"
      />
      <button
        id="login-btn"
        class="w-full rounded-lg bg-black dark:bg-white text-white dark:text-black py-3 text-sm font-medium hover:opacity-80 transition-opacity"
      >
        Sign in
      </button>
      <p id="login-err" class="text-red-500 text-xs text-center hidden">Wrong password</p>
    </div>

    {/* ── UPLOAD PANEL ───────────────────── */}
    <div id="panel" class="hidden w-full max-w-lg flex flex-col gap-6">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-semibold tracking-tight">Upload Wallpapers</h1>
        <button id="logout-btn" class="text-xs text-neutral-500 hover:text-black dark:hover:text-white underline">Logout</button>
      </div>

      {/* Drop zone */}
      <label
        id="dropzone"
        class="flex flex-col items-center justify-center gap-3 rounded-2xl border-2 border-dashed border-neutral-300 dark:border-neutral-700 p-10 cursor-pointer transition-colors hover:border-black dark:hover:border-white"
      >
        <svg class="h-10 w-10 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path d="M12 16V4m0 0-4 4m4-4 4 4M4 20h16" />
        </svg>
        <p class="text-sm text-neutral-500">
          <span class="font-medium text-black dark:text-white">Click to select</span> or drag & drop
        </p>
        <p class="text-xs text-neutral-400">JPG, PNG, WebP</p>
        <input id="file-input" type="file" accept="image/*" multiple class="hidden" />
      </label>

      {/* Queue */}
      <div id="queue" class="flex flex-col gap-2"></div>

      {/* Status */}
      <p id="status" class="text-sm text-neutral-500 text-center hidden"></p>
    </div>
  </div>

  <script is:inline>
    (function() {
      var pw = document.getElementById("pw");
      var loginBtn = document.getElementById("login-btn");
      var loginDiv = document.getElementById("login");
      var loginErr = document.getElementById("login-err");
      var panel = document.getElementById("panel");
      var logoutBtn = document.getElementById("logout-btn");
      var dropzone = document.getElementById("dropzone");
      var fileInput = document.getElementById("file-input");
      var queue = document.getElementById("queue");
      var status = document.getElementById("status");

      var adminPw = localStorage.getItem("admin_pw") || "";

      /* ── Auth ─────────────────────────── */
      function showPanel() {
        loginDiv.classList.add("hidden");
        panel.classList.remove("hidden");
      }

      function showLogin() {
        panel.classList.add("hidden");
        loginDiv.classList.remove("hidden");
      }

      /* Auto-login if saved */
      if (adminPw) {
        fetch("/api/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: adminPw })
        }).then(function(r) {
          if (r.ok) showPanel(); else showLogin();
        }).catch(function() { showLogin(); });
      }

      loginBtn.addEventListener("click", function() {
        var val = pw.value;
        fetch("/api/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: val })
        }).then(function(r) {
          if (r.ok) {
            adminPw = val;
            localStorage.setItem("admin_pw", val);
            loginErr.classList.add("hidden");
            showPanel();
          } else {
            loginErr.classList.remove("hidden");
          }
        });
      });

      pw.addEventListener("keydown", function(e) {
        if (e.key === "Enter") loginBtn.click();
      });

      logoutBtn.addEventListener("click", function() {
        adminPw = "";
        localStorage.removeItem("admin_pw");
        showLogin();
      });

      /* ── Upload ───────────────────────── */
      var uploading = false;

      function addFiles(files) {
        if (uploading) return;
        var arr = Array.prototype.slice.call(files);
        arr = arr.filter(function(f) { return /\.(jpe?g|png|webp)$/i.test(f.name); });
        if (arr.length === 0) return;

        uploading = true;
        status.classList.remove("hidden");
        status.textContent = "Uploading 0 / " + arr.length + "…";

        var done = 0;
        var failed = 0;

        function next(i) {
          if (i >= arr.length) {
            uploading = false;
            status.textContent = "Done! " + done + " uploaded" + (failed ? ", " + failed + " failed" : "") + ". GitHub Actions will process them automatically.";
            return;
          }

          var file = arr[i];
          var row = document.createElement("div");
          row.className = "flex items-center gap-3 rounded-lg bg-neutral-100 dark:bg-neutral-900 px-3 py-2 text-sm";
          row.innerHTML = '<span class="truncate flex-1">' + file.name + '</span><span class="upload-status text-neutral-400 shrink-0">waiting…</span>';
          queue.appendChild(row);
          var statusSpan = row.querySelector(".upload-status");

          statusSpan.textContent = "uploading…";
          statusSpan.className = "upload-status text-yellow-500 shrink-0";

          var form = new FormData();
          form.append("file", file);

          fetch("/api/upload", {
            method: "POST",
            headers: { "x-admin-password": adminPw },
            body: form
          }).then(function(r) {
            return r.json().then(function(data) {
              if (r.ok && data.ok) {
                done++;
                statusSpan.textContent = "✓";
                statusSpan.className = "upload-status text-green-500 shrink-0";
              } else {
                failed++;
                statusSpan.textContent = data.error || "failed";
                statusSpan.className = "upload-status text-red-500 shrink-0";
              }
            });
          }).catch(function() {
            failed++;
            statusSpan.textContent = "error";
            statusSpan.className = "upload-status text-red-500 shrink-0";
          }).finally(function() {
            status.textContent = "Uploading " + (done + failed) + " / " + arr.length + "…";
            next(i + 1);
          });
        }

        next(0);
      }

      fileInput.addEventListener("change", function() {
        if (fileInput.files.length) addFiles(fileInput.files);
      });

      dropzone.addEventListener("dragover", function(e) {
        e.preventDefault();
        dropzone.classList.add("border-black", "dark:border-white");
      });

      dropzone.addEventListener("dragleave", function() {
        dropzone.classList.remove("border-black", "dark:border-white");
      });

      dropzone.addEventListener("drop", function(e) {
        e.preventDefault();
        dropzone.classList.remove("border-black", "dark:border-white");
        if (e.dataTransfer.files.length) addFiles(e.dataTransfer.files);
      });
    })();
  </script>
</Layout>
