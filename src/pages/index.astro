---
import "@/styles/global.css";
import Layout from "../layouts/Layout.astro";
import SEO from "../components/SEO.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Gallery from "../components/Gallery.astro";
import { siteConfig, cdnUrl } from "../config";
import metadata from "../data/metadata.json";
---

<Layout>
  <SEO slot="head" />
  <Header />

  <main class="flex-1">
    <Gallery />
  </main>

  <Footer />

  {/* ═══════════════════════════════════════════════════
      VIEWER MODAL
      ═══════════════════════════════════════════════════ */}
  <div
    id="viewer"
    class="fixed inset-0 z-50 hidden flex-col bg-black"
    role="dialog"
    aria-modal="true"
    aria-label="Photo viewer"
  >
    {/* Top bar */}
    <div class="flex items-center justify-end p-3 text-white/80">
      <button id="viewer-close" aria-label="Close" class="p-2 rounded-full hover:bg-white/10 transition-colors">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    {/* Image area */}
    <div id="viewer-stage" class="relative flex-1 flex items-center justify-center overflow-hidden touch-none select-none">
      <img id="viewer-img" class="max-h-full max-w-full object-contain transition-opacity duration-200" draggable="false" alt="" />

      {/* Nav arrows (hidden on mobile — use swipe) */}
      <button id="viewer-prev" aria-label="Previous" class="hidden sm:flex absolute left-2 top-1/2 -translate-y-1/2 items-center justify-center h-10 w-10 rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6" /></svg>
      </button>
      <button id="viewer-next" aria-label="Next" class="hidden sm:flex absolute right-2 top-1/2 -translate-y-1/2 items-center justify-center h-10 w-10 rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6" /></svg>
      </button>
    </div>

    {/* Bottom actions */}
    <div class="flex items-center justify-center gap-3 p-4">
      <button id="viewer-download" class="flex items-center gap-2 rounded-full bg-white text-black px-5 py-2.5 text-sm font-medium hover:bg-neutral-200 transition-colors">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" /></svg>
        Download
      </button>
      <button id="viewer-copy" aria-label="Copy link" class="flex items-center justify-center h-10 w-10 rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></svg>
      </button>
      <button id="viewer-share" aria-label="Share" class="flex items-center justify-center h-10 w-10 rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3" /><circle cx="6" cy="12" r="3" /><circle cx="18" cy="19" r="3" /><path d="m8.59 13.51 6.83 3.98M15.41 6.51l-6.82 3.98" /></svg>
      </button>
    </div>

    {/* Toast */}
    <div id="viewer-toast" class="pointer-events-none fixed bottom-24 left-1/2 -translate-x-1/2 rounded-full bg-white text-black px-4 py-2 text-sm font-medium opacity-0 transition-opacity duration-300"></div>
  </div>

  {/* ═══════════════════════════════════════════════════
      CLIENT-SIDE SCRIPTS
      ═══════════════════════════════════════════════════ */}
  <script define:vars={{ imagesJSON: JSON.stringify(metadata.images), githubUser: siteConfig.github.user, githubRepo: siteConfig.github.repo, githubBranch: siteConfig.github.branch }}>
    /* ---------- DATA ---------- */
    const images = JSON.parse(imagesJSON);

    function cdnUrl(filepath) {
      return `https://cdn.jsdelivr.net/gh/${githubUser}/${githubRepo}@${githubBranch}/${filepath}`;
    }

    /* ---------- IMAGE LAZY-LOAD FADE ---------- */
    document.querySelectorAll(".wall-img").forEach(function(img) {
      function show() { img.classList.add("loaded"); }
      if (img.complete && img.naturalWidth > 0) show();
      else img.addEventListener("load", show);
    });

    /* ---------- GALLERY ---------- */
    var galleryEl = document.getElementById("gallery");
    var items = Array.prototype.slice.call(document.querySelectorAll(".gallery-item"));
    var noResults = document.getElementById("no-results");
    var tagBtns = Array.prototype.slice.call(document.querySelectorAll(".tag-btn"));
    var activeTag = "all";

    function filterGallery() {
      var visible = 0;
      items.forEach(function(el) {
        var tags = el.getAttribute("data-tags") || "";
        var matchTag = activeTag === "all" || tags.split(",").indexOf(activeTag) !== -1;
        el.style.display = matchTag ? "" : "none";
        if (matchTag) visible++;
      });
      if (noResults) noResults.classList.toggle("hidden", visible > 0);
    }

    tagBtns.forEach(function(btn) {
      btn.addEventListener("click", function() {
        activeTag = btn.getAttribute("data-tag");
        tagBtns.forEach(function(b) {
          var isActive = b === btn;
          b.classList.toggle("bg-black", isActive);
          b.classList.toggle("text-white", isActive);
          b.classList.toggle("dark:bg-white", isActive);
          b.classList.toggle("dark:text-black", isActive);
        });
        filterGallery();
      });
    });

    /* ---------- VIEWER ---------- */
    var viewer = document.getElementById("viewer");
    var viewerImg = document.getElementById("viewer-img");
    var viewerClose = document.getElementById("viewer-close");
    var viewerPrev = document.getElementById("viewer-prev");
    var viewerNext = document.getElementById("viewer-next");
    var viewerDownload = document.getElementById("viewer-download");
    var viewerCopy = document.getElementById("viewer-copy");
    var viewerShare = document.getElementById("viewer-share");
    var viewerToast = document.getElementById("viewer-toast");

    var current = -1;
    var touchStartX = 0;
    var touchStartY = 0;

    function visibleIndices() {
      var acc = [];
      items.forEach(function(el, i) {
        if (el.style.display !== "none") acc.push(i);
      });
      return acc;
    }

    function openViewer(index) {
      current = index;
      var img = images[index];
      if (!img) return;

      viewerImg.src = img.srcSet[1080] || img.srcSet[720] || img.srcSet[480];
      viewerImg.alt = "";
      viewer.classList.remove("hidden");
      viewer.classList.add("flex");
      document.body.style.overflow = "hidden";

      history.pushState({ viewer: true, id: img.id }, "", "/p/" + img.id);
    }

    function closeViewer() {
      viewer.classList.add("hidden");
      viewer.classList.remove("flex");
      document.body.style.overflow = "";
      if (history.state && history.state.viewer) history.back();
    }

    function navigate(dir) {
      var vis = visibleIndices();
      if (vis.length === 0) return;
      var pos = vis.indexOf(current);
      var next = (pos + dir + vis.length) % vis.length;
      current = vis[next];
      var img = images[current];
      viewerImg.style.opacity = "0";
      setTimeout(function() {
        viewerImg.src = img.srcSet[1080] || img.srcSet[720] || img.srcSet[480];
        viewerImg.alt = "";
        viewerImg.style.opacity = "1";
        history.replaceState({ viewer: true, id: img.id }, "", "/p/" + img.id);
      }, 150);
    }

    function toast(msg) {
      viewerToast.textContent = msg;
      viewerToast.style.opacity = "1";
      setTimeout(function() { viewerToast.style.opacity = "0"; }, 1800);
    }

    function downloadOriginal() {
      var img = images[current];
      if (!img) return;
      var url = cdnUrl("public" + img.original);
      fetch(url).then(function(res) {
        return res.blob();
      }).then(function(blob) {
        var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = img.id + img.original.substring(img.original.lastIndexOf("."));
        a.click();
        URL.revokeObjectURL(a.href);
      }).catch(function() {
        window.open(url, "_blank");
      });
    }

    function copyLink() {
      var img = images[current];
      if (!img) return;
      var url = location.origin + "/p/" + img.id;
      navigator.clipboard.writeText(url).then(function() { toast("Link copied"); });
    }

    function sharePhoto() {
      var img = images[current];
      if (!img || !navigator.share) { copyLink(); return; }
      navigator.share({ url: location.origin + "/p/" + img.id }).catch(function() {});
    }

    /* Event: open viewer from gallery click */
    items.forEach(function(el) {
      el.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        openViewer(Number(el.getAttribute("data-index")));
      });
    });

    /* Event: buttons */
    viewerClose.addEventListener("click", closeViewer);
    viewerPrev.addEventListener("click", function() { navigate(-1); });
    viewerNext.addEventListener("click", function() { navigate(1); });
    viewerDownload.addEventListener("click", downloadOriginal);
    viewerCopy.addEventListener("click", copyLink);
    viewerShare.addEventListener("click", sharePhoto);

    /* Event: keyboard */
    document.addEventListener("keydown", function(e) {
      if (viewer.classList.contains("hidden")) return;
      if (e.key === "Escape") closeViewer();
      if (e.key === "ArrowLeft") navigate(-1);
      if (e.key === "ArrowRight") navigate(1);
    });

    /* Event: touch swipe */
    var stage = document.getElementById("viewer-stage");
    stage.addEventListener("touchstart", function(e) {
      touchStartX = e.changedTouches[0].clientX;
      touchStartY = e.changedTouches[0].clientY;
    }, { passive: true });

    stage.addEventListener("touchend", function(e) {
      var dx = e.changedTouches[0].clientX - touchStartX;
      var dy = e.changedTouches[0].clientY - touchStartY;
      var absDx = Math.abs(dx);
      var absDy = Math.abs(dy);

      if (absDx > 50 && absDx > absDy) {
        navigate(dx < 0 ? 1 : -1);
      } else if (dy > 80 && absDy > absDx) {
        closeViewer();
      }
    }, { passive: true });

    /* Event: browser back button */
    window.addEventListener("popstate", function() {
      if (!viewer.classList.contains("hidden")) {
        viewer.classList.add("hidden");
        viewer.classList.remove("flex");
        document.body.style.overflow = "";
      }
    });
  </script>
</Layout>
